<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ¿é—´ {{ room.room_id }} - Luogu Duels</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>âš”ï¸ æˆ¿é—´ {{ room.room_id }}</h1>
        <div class="user-info">
            <span>ä½ å¥½, {{ current_user.luogu_name }}!</span>
            <a href="{{ url_for('logout') }}">æ³¨é”€</a>
        </div>
    </div>

    <div class="layout">
        <div class="left-panel">
            <div id="status" class="card">
                <h3>æ¯”åˆ†ä¸çŠ¶æ€</h3>
                <div id="score-display">
                    <div class="team-score team1">
                        <span>è“é˜Ÿ (Team1): </span>
                        <span id="score1">{{ room.scores.team1 }}</span>
                    </div>
                    <div class="team-score team2">
                        <span>çº¢é˜Ÿ (Team2): </span>
                        <span id="score2">{{ room.scores.team2 }}</span>
                    </div>
                </div>
                <div id="problems-status">
                    <h4>é¢˜ç›®çŠ¶æ€</h4>
                    <ul id="problem-list">
                        {% for pid in room.problems %}
                        {% set solved_info = room.solved_by.get(pid) %}
                        <li class="{% if pid in room.solved %}solved{% else %}unsolved{% endif %}">
                            {{ pid }}
                            {% if solved_info %}
                            <span class="solved-by {{ 'team1' if solved_info.team == 'team1' else 'team2' }}"> ({{ solved_info.user }})</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% if room.finished %}
                <div id="winner-display">
                    <h3>ğŸ† èƒœè€…: <span id="winner-name" class="{{ 'team1' if room.winner == 'team1' else 'team2' }}">{{ room.winner or 'æœªçŸ¥' }}</span></h3>
                </div>
                {% endif %}
            </div>

            <div id="global-info" class="card">
                <h3>å…¨å±€ä¿¡æ¯</h3>
                <div id="team-members">
                    <h4>é˜Ÿä¼æˆå‘˜</h4>
                    <div class="team-members team1">
                        <strong>è“é˜Ÿ:</strong>
                        <span id="team1-members">{% for member in room.teams.team1 %}{{ member }}{% if not loop.last %}, {% endif %}{% endfor %}</span>
                    </div>
                    <div class="team-members team2">
                        <strong>çº¢é˜Ÿ:</strong>
                        <span id="team2-members">{% for member in room.teams.team2 %}{{ member }}{% if not loop.last %}, {% endif %}{% endfor %}</span>
                    </div>
                </div>
                <div id="proposals-log">
                    <h4>ç”³è¯·è®°å½•</h4>
                    <ul id="proposals-list">
                        <!-- Proposals will be added here dynamically -->
                    </ul>
                </div>
                <div id="deletion-proposals-log">
                    <h4>åˆ é™¤ç”³è¯·</h4>
                    <ul id="deletion-proposals-list">
                        <!-- Deletion proposals will be added here dynamically -->
                    </ul>
                </div>
            </div>

            <div class="card">
                <h3>æˆ¿é—´æ“ä½œ</h3>
                <div>
                    <input type="text" id="new-pid-input" placeholder="é¢˜ç›®ç¼–å·ï¼Œå¦‚ P1234">
                    <button onclick="sendProposeMessage()">ç”³è¯·æ·»åŠ </button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="text" id="delete-pid-input" placeholder="é¢˜ç›®ç¼–å·ï¼Œå¦‚ P1234">
                    <button onclick="sendDeleteMessage()">ç”³è¯·åˆ é™¤</button>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div id="chat-box" class="card">
                <h3>é˜Ÿå†…èŠå¤©</h3>
                <div id="messages"></div>
                <div class="chat-input">
                    <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <button onclick="sendChat()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="winner-animation" style="display:none;">
        <div class="win-message">ğŸ‰ {{ room.winner or 'æœªçŸ¥é˜Ÿä¼' }} è·èƒœï¼</div>
    </div>

    <script>
        const socket = io();
        const roomId = "{{ room.room_id }}";
        let myTeam = null;
        let currentLuoguName = "{{ current_user.luogu_name }}";
        let roomTeams = {{ room.teams | tojson }};

        for (const [team, members] of Object.entries(roomTeams)) {
            if (members.includes(currentLuoguName)) {
                myTeam = team;
                break;
            }
        }
        if (!myTeam) {
            alert("é”™è¯¯ï¼šä½ ä¸åœ¨æˆ¿é—´çš„é˜Ÿä¼ä¸­ï¼");
            location.href = "/";
        }

        socket.emit("join_room", {room_id: roomId, team: myTeam});

        if (Notification.permission !== 'denied' && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }

        socket.on("update", (data) => {
            document.getElementById("score1").innerText = data.scores.team1;
            document.getElementById("score2").innerText = data.scores.team2;

            // Update problem list with solvers
            const problemList = document.getElementById("problem-list");
            problemList.innerHTML = "";
            data.problems.forEach(pid => {
                const li = document.createElement("li");
                li.textContent = pid;
                li.className = data.solved.includes(pid) ? "solved" : "unsolved";
                // Add solver info
                if (data.solved_by[pid]) {
                    const solverSpan = document.createElement("span");
                    solverSpan.className = `solved-by ${data.solved_by[pid].team === 'team1' ? 'team1' : 'team2'}`;
                    solverSpan.textContent = ` (${data.solved_by[pid].user})`;
                    li.appendChild(solverSpan);
                }
                problemList.appendChild(li);
            });

            document.getElementById("team1-members").innerText = data.teams.team1.join(", ");
            document.getElementById("team2-members").innerText = data.teams.team2.join(", ");

            const proposalsList = document.getElementById("proposals-list");
            proposalsList.innerHTML = "";
            data.proposals.forEach(prop => {
                const li = document.createElement("li");
                li.textContent = `[${prop.timestamp}] ${prop.proposer} ç”³è¯·æ·»åŠ : ${prop.pid} (${prop.status})`;
                if (prop.status === "pending") {
                    const acceptBtn = document.createElement("button");
                    acceptBtn.textContent = "åŒæ„";
                    acceptBtn.onclick = () => acceptProposal(prop.pid);
                    const rejectBtn = document.createElement("button"); // æ–°å¢æ‹’ç»æŒ‰é’®
                    rejectBtn.textContent = "æ‹’ç»";
                    rejectBtn.onclick = () => rejectProposal(prop.pid); // æ–°å¢æ‹’ç»å‡½æ•°
                    li.appendChild(acceptBtn);
                    li.appendChild(rejectBtn); // æ·»åŠ æ‹’ç»æŒ‰é’®
                }
                proposalsList.appendChild(li);
            });

            const delProposalsList = document.getElementById("deletion-proposals-list");
            delProposalsList.innerHTML = "";
            data.deletion_proposals.forEach(prop => {
                const li = document.createElement("li");
                li.textContent = `[${prop.timestamp}] ${prop.proposer} ç”³è¯·åˆ é™¤: ${prop.pid} (${prop.status})`;
                if (prop.status === "pending") {
                    const acceptBtn = document.createElement("button");
                    acceptBtn.textContent = "åŒæ„";
                    acceptBtn.onclick = () => acceptDeletion(prop.pid);
                    const rejectBtn = document.createElement("button"); // æ–°å¢æ‹’ç»æŒ‰é’®
                    rejectBtn.textContent = "æ‹’ç»";
                    rejectBtn.onclick = () => rejectDeletion(prop.pid); // æ–°å¢æ‹’ç»å‡½æ•°
                    li.appendChild(acceptBtn);
                    li.appendChild(rejectBtn); // æ·»åŠ æ‹’ç»æŒ‰é’®
                }
                delProposalsList.appendChild(li);
            });

            if (data.finished && !document.getElementById("winner-display")) {
                const winnerDiv = document.createElement("div");
                winnerDiv.id = "winner-display";
                winnerDiv.innerHTML = `<h3>ğŸ† èƒœè€…: <span id="winner-name" class="${data.winner === 'team1' ? 'team1' : 'team2'}">${data.winner}</span></h3>`;
                document.getElementById("status").appendChild(winnerDiv);
                document.getElementById("winner-animation").style.display = "flex";
            }
        });

        socket.on("game_over", (data) => {
            document.getElementById("winner-animation").style.display = "flex";
            document.getElementById("winner-name").textContent = data.winner;
            document.getElementById("winner-name").className = data.winner === 'team1' ? 'team1' : 'team2';
        });

        socket.on("proposal_request", (data) => {
            if (Notification.permission === "granted") {
                new Notification(`é¢˜ç›®ç”³è¯·`, {
                    body: `${data.proposer} ç”³è¯·æ·»åŠ  ${data.pid}`
                });
            }
        });

        socket.on("deletion_request", (data) => {
            if (Notification.permission === "granted") {
                new Notification(`é¢˜ç›®åˆ é™¤ç”³è¯·`, {
                    body: `${data.proposer} ç”³è¯·åˆ é™¤ ${data.pid}`
                });
            }
        });

        socket.on("message", (msg) => {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("div");
            messageElement.className = "message";
            messageElement.innerHTML = `<strong>${msg.user}</strong> <span class="time">(${msg.time})</span>: ${msg.text}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (Notification.permission === "granted") {
                new Notification(`æ¥è‡ª ${msg.user}`, {
                    body: msg.text,
                    icon: "/static/logo.png"
                });
            }
        });

        function sendChat() {
            const input = document.getElementById("msg-input");
            const text = input.value.trim();
            if (!text) return;

            socket.emit("chat", {
                room_id: roomId,
                team: myTeam,
                user: currentLuoguName,
                text: text
            });
            input.value = "";
        }

        // --- Send commands as chat messages ---
        function sendProposeMessage() {
            const pidInput = document.getElementById("new-pid-input");
            const pid = pidInput.value.trim();
            if (!pid) {
                alert("è¯·è¾“å…¥é¢˜ç›®ç¼–å·");
                return;
            }
            socket.emit("chat", {
                room_id: roomId,
                team: myTeam,
                user: currentLuoguName,
                text: `!propose ${pid}`
            });
            pidInput.value = "";
        }

        function sendDeleteMessage() {
            const pidInput = document.getElementById("delete-pid-input");
            const pid = pidInput.value.trim();
            if (!pid) {
                alert("è¯·è¾“å…¥é¢˜ç›®ç¼–å·");
                return;
            }
            socket.emit("chat", {
                room_id: roomId,
                team: myTeam,
                user: currentLuoguName,
                text: `!delete ${pid}`
            });
            pidInput.value = "";
        }

        // --- API calls for accepting ---
        function acceptProposal(pid) {
            if (!confirm(`ç¡®å®šè¦åŒæ„æ·»åŠ é¢˜ç›® ${pid} å—ï¼Ÿ`)) {
                return;
            }
            fetch("/api/accept_proposal", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Proposal accepted");
                } else {
                    alert("åŒæ„å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Accept Propose error:", error);
                alert("åŒæ„å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function acceptDeletion(pid) {
             if (!confirm(`ç¡®å®šè¦åŒæ„åˆ é™¤é¢˜ç›® ${pid} å—ï¼Ÿ`)) {
                return;
            }
            fetch("/api/accept_delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Deletion accepted");
                } else {
                    alert("åŒæ„å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Accept Delete error:", error);
                alert("åŒæ„å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        // --- New API calls for rejecting ---
        function rejectProposal(pid) {
            if (!confirm(`ç¡®å®šè¦æ‹’ç»æ·»åŠ é¢˜ç›® ${pid} å—ï¼Ÿ`)) {
                return;
            }
            fetch("/api/reject_proposal", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Proposal rejected");
                } else {
                    alert("æ‹’ç»å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Reject Propose error:", error);
                alert("æ‹’ç»å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function rejectDeletion(pid) {
             if (!confirm(`ç¡®å®šè¦æ‹’ç»åˆ é™¤é¢˜ç›® ${pid} å—ï¼Ÿ`)) {
                return;
            }
            fetch("/api/reject_delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Deletion rejected");
                } else {
                    alert("æ‹’ç»å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Reject Delete error:", error);
                alert("æ‹’ç»å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function leaveRoom() {
            if (!confirm("ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ")) {
                return;
            }

            fetch("/api/leave", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    alert("å·²ç¦»å¼€æˆ¿é—´");
                    location.href = "/";
                } else {
                    alert("ç¦»å¼€å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Leave error:", error);
                alert("ç¦»å¼€å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        document.getElementById("msg-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendChat();
            }
        });

        document.getElementById("new-pid-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendProposeMessage();
            }
        });

        document.getElementById("delete-pid-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendDeleteMessage();
            }
        });
    </script>
</body>
</html>