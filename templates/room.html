<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ¿é—´ {{ room.room_id }} - Luogu Duels</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>âš”ï¸ æˆ¿é—´ {{ room.room_id }}</h1>
        <div class="user-info">
            <span>ä½ å¥½, {{ current_user.luogu_name }}!</span>
            <a href="{{ url_for('logout') }}">æ³¨é”€</a>
        </div>
    </div>

    <div class="layout">
        <div class="left-panel">
            <div id="status" class="card">
                <h3>æ¯”åˆ†ä¸çŠ¶æ€</h3>
                <div id="score-display">
                    <div class="team-score team1">
                        <span id="team1-name">{{ room.teams.keys() | list | first }}: </span>
                        <span id="score1">{{ room.scores[room.teams.keys() | list | first] }}</span>
                    </div>
                    <div class="team-score team2">
                        <span id="team2-name">{{ room.teams.keys() | list | last }}: </span>
                        <span id="score2">{{ room.scores[room.teams.keys() | list | last] }}</span>
                    </div>
                </div>
                <div id="problems-status">
                    <h4>é¢˜ç›®çŠ¶æ€</h4>
                    <ul id="problem-list">
                        {% for pid in room.problems %}
                        {% set solved_info = room.solved_by.get(pid) %}
                        <li class="{% if pid in room.solved %}solved{% else %}unsolved{% endif %}">
                            {{ pid }}
                            {% if solved_info %}
                            <span class="solved-by {{ 'team1' if solved_info.team == (room.teams.keys() | list | first) else 'team2' }}"> ({{ solved_info.user }})</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% if room.finished %}
                <div id="winner-display">
                    <h3>ğŸ† èƒœè€…: <span id="winner-name" class="{{ 'team1' if room.winner == (room.teams.keys() | list | first) else 'team2' }}">{{ room.winner or 'æœªçŸ¥é˜Ÿä¼' }}</span></h3>
                </div>
                {% endif %}
            </div>

            <div id="global-info" class="card">
                <h3>å…¨å±€ä¿¡æ¯</h3>
                <div id="team-members">
                    <h4>é˜Ÿä¼æˆå‘˜</h4>
                    <div class="team-members team1">
                        <span id="team1-label">{{ room.teams.keys() | list | first }}:</span>
                        <span id="team1-members">{% for member in room.teams[room.teams.keys() | list | first] %}{{ member }}{% if not loop.last %}, {% endif %}{% endfor %}</span>
                    </div>
                    <div class="team-members team2">
                        <span id="team2-label">{{ room.teams.keys() | list | last }}:</span>
                        <span id="team2-members">{% for member in room.teams[room.teams.keys() | list | last] %}{{ member }}{% if not loop.last %}, {% endif %}{% endfor %}</span>
                    </div>
                </div>
                <div id="proposals-log">
                    <h4>ç”³è¯·è®°å½•</h4>
                    <ul id="proposals-list">
                        <!-- Proposals will be added here dynamically -->
                    </ul>
                </div>
                <div id="deletion-proposals-log">
                    <h4>åˆ é™¤ç”³è¯·</h4>
                    <ul id="deletion-proposals-list">
                        <!-- Deletion proposals will be added here dynamically -->
                    </ul>
                </div>
            </div>

            <div class="card">
                <h3>æˆ¿é—´æ“ä½œ</h3>
                <div>
                    <input type="text" id="new-pid-input" placeholder="é¢˜ç›®ç¼–å·ï¼Œå¦‚ P1234">
                    <button onclick="sendProposeMessage()">ç”³è¯·æ·»åŠ </button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="text" id="delete-pid-input" placeholder="é¢˜ç›®ç¼–å·ï¼Œå¦‚ P1234">
                    <button onclick="sendDeleteMessage()">ç”³è¯·åˆ é™¤</button>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div id="chat-box" class="card">
                <h3>é˜Ÿå†…èŠå¤©</h3>
                <div id="messages"></div>
                <div class="chat-input">
                    <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <button onclick="sendChat()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="winner-animation" style="display:none;">
        <div class="win-message">ğŸ‰ {{ room.winner or 'æœªçŸ¥é˜Ÿä¼' }} è·èƒœï¼</div>
    </div>

    <!-- é€‰æ‹©é˜Ÿä¼å¼¹çª— -->
    <div id="team-select-modal" class="modal">
        <div class="modal-content">
            <h3>é€‰æ‹©é˜Ÿä¼</h3>
            <p>æˆ¿é—´: {{ room.room_id }}</p>
            <label for="team-select">åŠ å…¥é˜Ÿä¼:</label>
            <select id="team-select">
                <option value="">-- é€‰æ‹©é˜Ÿä¼ --</option>
                <!-- é€‰é¡¹å°†é€šè¿‡ JS åŠ¨æ€å¡«å…… -->
            </select>
            <div class="modal-buttons">
                <button onclick="joinTeam()">åŠ å…¥</button>
                <button onclick="cancelJoin()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¼¹çª— -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">ç¡®è®¤</h3>
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-yes-btn">æ˜¯</button>
                <button id="confirm-no-btn">å¦</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const roomId = "{{ room.room_id }}";
        let myTeam = null; // Will be set after joining a team
        let currentLuoguName = "{{ current_user.luogu_name }}";
        let roomTeams = {{ room.teams | tojson }};
        let availableTeams = Object.keys(roomTeams);

        // Check if user is already in a team
        for (const [team, members] of Object.entries(roomTeams)) {
            if (members.includes(currentLuoguName)) {
                myTeam = team;
                break;
            }
        }

        // If not in a team, show the team selection modal
        if (!myTeam) {
            openTeamSelectModal();
        } else {
            // If already in a team, join the SocketIO rooms
            socket.emit("join_room", {room_id: roomId, team: myTeam});
        }

        if (Notification.permission !== 'denied' && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }

        socket.on("update", (data) => {
            // Update team names dynamically
            document.getElementById("team1-name").textContent = availableTeams[0] + ": ";
            document.getElementById("team2-name").textContent = availableTeams[1] + ": ";
            document.getElementById("team1-label").textContent = availableTeams[0] + ":";
            document.getElementById("team2-label").textContent = availableTeams[1] + ":";

            document.getElementById("score1").innerText = data.scores[availableTeams[0]];
            document.getElementById("score2").innerText = data.scores[availableTeams[1]];

            const problemList = document.getElementById("problem-list");
            problemList.innerHTML = "";
            data.problems.forEach(pid => {
                const li = document.createElement("li");
                li.textContent = pid;
                li.className = data.solved.includes(pid) ? "solved" : "unsolved";
                if (data.solved_by[pid]) {
                    const solverSpan = document.createElement("span");
                    solverSpan.className = `solved-by ${data.solved_by[pid].team === availableTeams[0] ? 'team1' : 'team2'}`;
                    solverSpan.textContent = ` (${data.solved_by[pid].user})`;
                    li.appendChild(solverSpan);
                }
                problemList.appendChild(li);
            });

            document.getElementById("team1-members").innerText = data.teams[availableTeams[0]].join(", ");
            document.getElementById("team2-members").innerText = data.teams[availableTeams[1]].join(", ");

            const proposalsList = document.getElementById("proposals-list");
            proposalsList.innerHTML = "";
            data.proposals.forEach(prop => {
                const li = document.createElement("li");
                li.textContent = `[${prop.timestamp}] ${prop.proposer} ç”³è¯·æ·»åŠ : ${prop.pid} (${prop.status})`;
                if (prop.status === "pending") {
                    const acceptBtn = document.createElement("button");
                    acceptBtn.textContent = "åŒæ„";
                    acceptBtn.onclick = () => showConfirm(`ç¡®å®šè¦åŒæ„æ·»åŠ é¢˜ç›® ${prop.pid} å—ï¼Ÿ`, () => acceptProposal(prop.pid));
                    const rejectBtn = document.createElement("button");
                    rejectBtn.textContent = "æ‹’ç»";
                    rejectBtn.onclick = () => showConfirm(`ç¡®å®šè¦æ‹’ç»æ·»åŠ é¢˜ç›® ${prop.pid} å—ï¼Ÿ`, () => rejectProposal(prop.pid));
                    li.appendChild(acceptBtn);
                    li.appendChild(rejectBtn);
                }
                proposalsList.appendChild(li);
            });

            const delProposalsList = document.getElementById("deletion-proposals-list");
            delProposalsList.innerHTML = "";
            data.deletion_proposals.forEach(prop => {
                const li = document.createElement("li");
                li.textContent = `[${prop.timestamp}] ${prop.proposer} ç”³è¯·åˆ é™¤: ${prop.pid} (${prop.status})`;
                if (prop.status === "pending") {
                    const acceptBtn = document.createElement("button");
                    acceptBtn.textContent = "åŒæ„";
                    acceptBtn.onclick = () => showConfirm(`ç¡®å®šè¦åŒæ„åˆ é™¤é¢˜ç›® ${prop.pid} å—ï¼Ÿ`, () => acceptDeletion(prop.pid));
                    const rejectBtn = document.createElement("button");
                    rejectBtn.textContent = "æ‹’ç»";
                    rejectBtn.onclick = () => showConfirm(`ç¡®å®šè¦æ‹’ç»åˆ é™¤é¢˜ç›® ${prop.pid} å—ï¼Ÿ`, () => rejectDeletion(prop.pid));
                    li.appendChild(acceptBtn);
                    li.appendChild(rejectBtn);
                }
                delProposalsList.appendChild(li);
            });

            if (data.finished && !document.getElementById("winner-display")) {
                const winnerDiv = document.createElement("div");
                winnerDiv.id = "winner-display";
                winnerDiv.innerHTML = `<h3>ğŸ† èƒœè€…: <span id="winner-name" class="${data.winner === availableTeams[0] ? 'team1' : 'team2'}">${data.winner}</span></h3>`;
                document.getElementById("status").appendChild(winnerDiv);
                document.getElementById("winner-animation").style.display = "flex";
            }
        });

        socket.on("game_over", (data) => {
            document.getElementById("winner-animation").style.display = "flex";
            document.getElementById("winner-name").textContent = data.winner;
            document.getElementById("winner-name").className = data.winner === availableTeams[0] ? 'team1' : 'team2';
        });

        socket.on("proposal_request", (data) => {
            if (Notification.permission === "granted") {
                new Notification(`é¢˜ç›®ç”³è¯·`, {
                    body: `${data.proposer} ç”³è¯·æ·»åŠ  ${data.pid}`
                });
            }
        });

        socket.on("deletion_request", (data) => {
            if (Notification.permission === "granted") {
                new Notification(`é¢˜ç›®åˆ é™¤ç”³è¯·`, {
                    body: `${data.proposer} ç”³è¯·åˆ é™¤ ${data.pid}`
                });
            }
        });

        socket.on("message", (msg) => {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("div");
            messageElement.className = "message";
            messageElement.innerHTML = `<strong>${msg.user}</strong> <span class="time">(${msg.time})</span>: ${msg.text}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (Notification.permission === "granted") {
                new Notification(`æ¥è‡ª ${msg.user}`, {
                    body: msg.text,
                    icon: "/static/logo.png"
                });
            }
        });

        // --- Modal Functions ---
        function openTeamSelectModal() {
            const select = document.getElementById('team-select');
            select.innerHTML = '<option value="">-- é€‰æ‹©é˜Ÿä¼ --</option>'; // Clear options
            availableTeams.forEach(teamName => {
                const option = document.createElement('option');
                option.value = teamName;
                // Show team name and remaining slots (optional)
                const slots = 4 - roomTeams[teamName].length; // Assuming max 4 per team
                option.textContent = `${teamName} (${slots} ä¸ªç©ºä½)`;
                select.appendChild(option);
            });
            document.getElementById('team-select-modal').style.display = 'block';
        }

        function closeTeamSelectModal() {
            document.getElementById('team-select-modal').style.display = 'none';
        }

        function openConfirmModal(title, message, onYes) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-yes-btn').onclick = () => {
                onYes();
                closeConfirmModal();
            };
            document.getElementById('confirm-no-btn').onclick = closeConfirmModal;
            document.getElementById('confirm-modal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        function showConfirm(message, onYes) {
            openConfirmModal("ç¡®è®¤", message, onYes);
        }

        // --- Functions ---
        function joinTeam() {
            const selectedTeam = document.getElementById('team-select').value;
            if (!selectedTeam) {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªé˜Ÿä¼");
                return;
            }

            fetch('/api/join', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({room_id: roomId, team: selectedTeam})
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    myTeam = selectedTeam; // Set myTeam after successful join
                    socket.emit("join_room", {room_id: roomId, team: myTeam}); // Join SocketIO room
                    closeTeamSelectModal();
                    alert("åŠ å…¥æˆåŠŸï¼");
                } else {
                    alert('åŠ å…¥å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('Join error:', error);
                alert("åŠ å…¥å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function cancelJoin() {
            // If user cancels joining, redirect back to index
            if (!myTeam) {
                window.location.href = '/';
            } else {
                closeTeamSelectModal();
            }
        }

        function sendChat() {
            const input = document.getElementById("msg-input");
            const text = input.value.trim();
            if (!text) return;

            socket.emit("chat", {
                room_id: roomId,
                team: myTeam,
                user: currentLuoguName,
                text: text
            });
            input.value = "";
        }

        function sendProposeMessage() {
            const pidInput = document.getElementById("new-pid-input");
            const pid = pidInput.value.trim();
            if (!pid) {
                alert("è¯·è¾“å…¥é¢˜ç›®ç¼–å·");
                return;
            }
            socket.emit("chat", {
                room_id: roomId,
                team: myTeam,
                user: currentLuoguName,
                text: `!propose ${pid}`
            });
            pidInput.value = "";
        }

        function sendDeleteMessage() {
            const pidInput = document.getElementById("delete-pid-input");
            const pid = pidInput.value.trim();
            if (!pid) {
                alert("è¯·è¾“å…¥é¢˜ç›®ç¼–å·");
                return;
            }
            socket.emit("chat", {
                room_id: roomId,
                team: myTeam,
                user: currentLuoguName,
                text: `!delete ${pid}`
            });
            pidInput.value = "";
        }

        // --- API calls with confirm ---
        function acceptProposal(pid) {
            fetch("/api/accept_proposal", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Proposal accepted");
                } else {
                    alert("åŒæ„å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Accept Propose error:", error);
                alert("åŒæ„å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function acceptDeletion(pid) {
            fetch("/api/accept_delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Deletion accepted");
                } else {
                    alert("åŒæ„å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Accept Delete error:", error);
                alert("åŒæ„å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function rejectProposal(pid) {
            fetch("/api/reject_proposal", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Proposal rejected");
                } else {
                    alert("æ‹’ç»å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Reject Propose error:", error);
                alert("æ‹’ç»å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function rejectDeletion(pid) {
            fetch("/api/reject_delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    room_id: roomId,
                    pid: pid
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.ok) {
                    console.log("Deletion rejected");
                } else {
                    alert("æ‹’ç»å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                }
            })
            .catch(error => {
                console.error("Reject Delete error:", error);
                alert("æ‹’ç»å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
            });
        }

        function leaveRoom() {
            showConfirm("ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ", function() {
                fetch("/api/leave", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        room_id: roomId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.ok) {
                        alert("å·²ç¦»å¼€æˆ¿é—´");
                        window.location.href = "/";
                    } else {
                        alert("ç¦»å¼€å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                    }
                })
                .catch(error => {
                    console.error("Leave error:", error);
                    alert("ç¦»å¼€å¤±è´¥: ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
                });
            });
        }

        document.getElementById("msg-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendChat();
            }
        });

        document.getElementById("new-pid-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendProposeMessage();
            }
        });

        document.getElementById("delete-pid-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendDeleteMessage();
            }
        });

        // Click outside modals to close them
        window.onclick = function(event) {
            const teamSelectModal = document.getElementById('team-select-modal');
            const confirmModal = document.getElementById('confirm-modal');
            if (event.target === teamSelectModal) {
                cancelJoin(); // Use cancelJoin logic
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }
    </script>
</body>
</html>